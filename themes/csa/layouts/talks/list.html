{{ define "main" }}
  {{/* --------- Config / Inputs --------- */}}
  {{/* Expects data/talks.yaml to be a list like:
      - title: "Talk title"
        date: 2025-05-02T15:30:00-05:00   # RFC3339 recommended
        speakers: ["Name (Affiliation)"]
        venue: "Room 170"
        slides: "https://example.com/slides.pdf"
        video: "https://youtu.be/xxxx"
        abstract: "Short summary..."
  */}}

  {{ $talks := .Site.Data.talks }}
  {{ if not $talks }}
    <section class="space-y-8">
      <h1 class="text-3xl font-semibold">Past CSA Talks</h1>
      <p class="text-gray-600">No talks data found. Add <code>data/talks.yaml</code>.</p>
    </section>
    {{ end }}
  {{ if not $talks }}{{/* early exit */}}{{ return }}{{ end }}

  {{/* --------- Prepare lists --------- */}}
  {{ $now := now }}
  {{ $sorted := sort $talks "date" "desc" }}
  {{ $.Scratch.Set "past" (slice) }}

    {{ $.Scratch.Set "upcoming" (slice) }}
  {{ range $sorted }}
    {{ $t := time .date }}
    {{ if lt $t $now }}
      {{ $.Scratch.Add "past" (slice .) }}
      {{ else }}
        {{ $.Scratch.Add "upcoming" (slice .) }}
    {{ end }}
  {{ end }}

  {{ $past := $.Scratch.Get "past" }}

    {{ $upcoming := $.Scratch.Get "upcoming" }}
  <section class="space-y-10">
    <section class="space-y-10">
      <header>
        <h1 class="text-3xl font-semibold">Upcoming CSA Talks</h1>
        {{ if eq (len $upcoming) 0 }}
          <p class="mt-2 text-gray-600">No upcoming talks scheduled.</p>
        {{ end }}
      </header>

      {{ if gt (len $upcoming) 0 }}
        <div class="space-y-8">
          <ul class="mt-2 grid gap-6 md:grid-cols-2">
          {{ range $upcoming }}
            {{ $t := time .date }}
            <li class="rounded-2xl border p-5 bg-white">
              <div class="flex items-start justify-between gap-4">
                <h3 class="text-xl font-medium">
                  {{ with .title }}
                    <span>{{ . }}</span>
                  {{ else }}
                    <span>Untitled talk</span>
                  {{ end }}
                </h3>
                <time class="shrink-0 text-sm text-gray-500" datetime="{{ $t }}">
                  {{ $t.Format "Jan 2, 2006" }}
                </time>
              </div>

              {{ with .speakers }}
                <p class="mt-2 text-sm text-gray-700">
                  <span class="font-medium">Speakers:</span> {{ delimit . ", " }}
                </p>
              {{ end }}

              {{ with .venue }}
                <p class="text-sm text-gray-700"><span class="font-medium">Venue:</span> {{ . }}</p>
              {{ end }}

              {{ with .abstract }}
                <p class="mt-3 text-sm text-gray-600">{{ . }}</p>
              {{ end }}

              <div class="mt-4 flex flex-wrap gap-3 text-sm">
                {{ with .slides }}
                  <a class="underline" href="{{ . }}" target="_blank" rel="noopener">Slides</a>
                {{ end }}
                {{ with .video }}
                  <a class="underline" href="{{ . }}" target="_blank" rel="noopener">Video</a>
                {{ end }}
              </div>
            </li>
          {{ end }}
          </ul>
        </div>
      {{ end }}
    </section>
    <header>
      <h1 class="text-3xl font-semibold">Past CSA Talks</h1>
      {{ if eq (len $past) 0 }}
        <p class="mt-2 text-gray-600">No past talks yet.</p>
      {{ end }}
    </header>

    {{ if gt (len $past) 0 }}
      {{/* Group by year while iterating */}}
      {{ $.Scratch.Delete "currentYear" }}
      <div class="space-y-8">
        {{ range $past }}
          {{ $t := time .date }}
          {{ $year := time.Format "2006" $t }}
          {{ if ne $year ($.Scratch.Get "currentYear") }}
            {{ if $.Scratch.Get "currentYear" }}
              </ul>
            {{ end }}
            <h2 class="text-2xl font-medium mt-4">{{ $year }}</h2>
            <ul class="mt-2 grid gap-6 md:grid-cols-2">
            {{ $.Scratch.Set "currentYear" $year }}
          {{ end }}

          <li class="rounded-2xl border p-5 bg-white">
            <div class="flex items-start justify-between gap-4">
              <h3 class="text-xl font-medium">
                {{ with .title }}
                  <span>{{ . }}</span>
                {{ else }}
                  <span>Untitled talk</span>
                {{ end }}
              </h3>
              <time class="shrink-0 text-sm text-gray-500" datetime="{{ $t }}">
                {{ $t.Format "Jan 2, 2006" }}
              </time>
            </div>

            {{ with .speakers }}
              <p class="mt-2 text-sm text-gray-700">
                <span class="font-medium">Speakers:</span> {{ delimit . ", " }}
              </p>
            {{ end }}

            {{ with .venue }}
              <p class="text-sm text-gray-700"><span class="font-medium">Venue:</span> {{ . }}</p>
            {{ end }}

            {{ with .abstract }}
              <p class="mt-3 text-sm text-gray-600">{{ . }}</p>
            {{ end }}

            <div class="mt-4 flex flex-wrap gap-3 text-sm">
              {{ with .slides }}
                <a class="underline" href="{{ . }}" target="_blank" rel="noopener">Slides</a>
              {{ end }}
              {{ with .video }}
                <a class="underline" href="{{ . }}" target="_blank" rel="noopener">Video</a>
              {{ end }}
            </div>
          </li>
        {{ end }}
        </ul>
      </div>
    {{ end }}
  </section>
{{ end }}
